defineM("code-editor",(function(e,o,t,r){"use strict";var i,d,n,s=!1,c=!1,a=0,l=!1,p=!1,h=!1,m="",u="",f=o.isSecondaryComponent||function(){return!1};function b(){if(!o.$body.find("#theme-settings .edit-in-code-editor-btn").length){var e='<button type="button" class="btn btn-primary edit-in-code-editor-btn">'+r("Edit in Code Editor")+"</button>";o.$body.find("#theme-settings .app-layer-cont").append(e),o.$body.find("#theme-settings .edit-in-code-editor-btn").on("click",(function(){o.showSiteCodeEditor()}))}}function g(r){var i=e.Deferred();if(!0===r||void 0===o.projectSettings.theme.staticStyles)if(m)i.resolve(m);else{var d=o.getPlugin("Theme");if(d)for(var n in d.files){var s=d.files[n];if("string"==typeof s&&(s={src:s}),/.css$/g.test(s.src)){t.loadLocalFile(o.theme.pathExport+"/plugins/"+s.src,(function(e){m=e,i.resolve(e)}));break}}else console.warn("Theme CSS styles not found!"),i.resolve()}else i.resolve(o.projectSettings.theme.staticStyles);return i}var v=null;function C(){clearTimeout(v),v=setTimeout((function(){var e=function(e){var t=e.val();if(""===t||t.indexOf(" ")>=0)return e.addClass("error-input"),!0;for(var r=o.Core.resultJSON[o.Core.currentPage].components,i=o.$codeEditorCSS.currentComponentID,d=0;d<r.length;d++)if(r[d]._id!=i&&t===r[d]._anchor)return e.addClass("error-input"),!0;return e.removeClass("error-input"),!1}(o.$codeEditor.find("#block-anchor")),t=o.$codeEditor.find(".code-editor-save"),i=o.$codeEditor.find(".code-editor-save-wrapper");e||o.$codeEditor.find(".cm-error").length>0?(t.removeClass("btn-primary").addClass("btn-material-red").attr("disabled","").find(".mbr-icon-check").removeClass("mbr-icon-check").addClass("mbr-icon-frowning-face"),e?i.tooltipster("content",r("Fix block anchor")):i.tooltipster("content",r("Fix invalid code (marked in red)")),i.tooltipster("enable"),t.tooltipster("disable")):(t.removeClass("btn-material-red").addClass("btn-primary").removeAttr("disabled").find(".mbr-icon-frowning-face").removeClass("mbr-icon-frowning-face").addClass("mbr-icon-check"),i.tooltipster("disable"),t.tooltipster("enable"))}),501)}var S=null;function $(){clearTimeout(S),S=setTimeout((function(){var e=o.$siteCodeEditor.find(".code-editor-save"),t=o.$siteCodeEditor.find(".code-editor-save-wrapper");o.$siteCodeEditor.find(".cm-error").length>0?(e.removeClass("btn-primary").addClass("btn-material-red").attr("disabled","").find(".mbr-icon-check").removeClass("mbr-icon-check").addClass("mbr-icon-frowning-face"),t.tooltipster("enable"),e.tooltipster("disable")):(e.removeClass("btn-material-red").addClass("btn-primary").removeAttr("disabled").find(".mbr-icon-frowning-face").removeClass("mbr-icon-frowning-face").addClass("mbr-icon-check"),t.tooltipster("disable"),e.tooltipster("enable"))}),501)}e(['<section id="component-code-editor" class="app-layer no-select">','<div class="app-layer-cont cont-table">','<div class="table-row table-row-bg">','<h4 class="app-layer-title">'+r("HTML Editor")+"</h4>",'<input id="block-anchor" type="text" class="form-control" data-tooltipster="bottom" title="'+r("Edit Block Anchor")+'">',"</div>",'<div class="table-row table-row-editor">','<div class="html-editor table-cell"></div>',"</div>",'<div class="table-row table-row-resizer">','<div class="table-cell"></div>',"</div>",'<div class="vertical-divider hidden"></div>','<div class="table-row table-row-bg"><h4 class="app-layer-title">'+r("CSS Editor")+"</h4></div>",'<div class="table-row table-row-editor">','<div class="css-editor table-cell"></div>',"</div>",'<div class="code-editor-top-buttons">','<a class="code-editor-help" data-tooltipster="bottom" title="'+r("Help")+'"><i class="mbr-icon-question"></i></a>','<a class="code-editor-settings" data-tooltipster="bottom" title="'+r("Settings")+'"><i class="mbr-icon-cog"></i></a>',"</div>",'<div class="code-editor-buttons">','<button class="code-editor-cancel btn btn-fab btn-raised btn-material-red" data-tooltipster="top" title="'+r("Cancel and Close")+'"><i class="mbr-icon-times"></i></button>','<button class="code-editor-undo btn btn-fab btn-raised btn-primary" data-tooltipster="top" title="'+r("Undo")+'"><i class="mbr-icon-undo"></i></button>','<button class="code-editor-redo btn btn-fab btn-raised btn-primary" data-tooltipster="top" title="'+r("Redo")+'"><i class="mbr-icon-redo"></i></button>','<div class="code-editor-save-wrapper" data-tooltipster="top">','<button class="code-editor-save btn btn-fab btn-raised btn-primary" data-tooltipster="top" title="'+r("Save and Close")+'"><i class="mbr-icon-check"></i></button>',"</div>",'<button class="code-editor-preview btn btn-fab btn-raised btn-info" data-tooltipster="top" title="'+r("Preview")+'"><i class="mbr-icon-eye"></i></button>',"</div>","</div>",'<div class="editor-resizer"></div>',"</section>",'<section id="site-code-editor" class="app-layer no-select">','<div class="app-layer-cont cont-table">','<div class="table-row table-row-bg"><h4 class="app-layer-title">'+r("Static Styles")+"</h4></div>",'<div class="table-row table-row-editor">','<div class="css-static-editor table-cell"></div>',"</div>",'<div class="table-row table-row-resizer resizer-1">','<div class="table-cell"></div>',"</div>",'<div class="vertical-divider vd-1 hidden"></div>','<div class="table-row table-row-bg"><h4 class="app-layer-title">'+r("Dynamic Styles")+"</h4></div>",'<div class="table-row table-row-editor">','<div class="css-dynamic-editor table-cell"></div>',"</div>",'<div class="table-row table-row-resizer resizer-2">','<div class="table-cell"></div>',"</div>",'<div class="vertical-divider vd-2 hidden"></div>','<div class="table-row table-row-bg"><h4 class="app-layer-title">'+r("Site Parameters")+"</h4></div>",'<div class="table-row table-row-editor">','<div class="json-params-editor table-cell"></div>',"</div>",'<div class="code-editor-top-buttons">','<a class="code-editor-restore" data-tooltipster="bottom" title="'+r("Restore Defaults")+'"><i class="mbr-icon-alternate-redo"></i></a>','<a class="code-editor-help" data-tooltipster="bottom" title="'+r("Help")+'"><i class="mbr-icon-question"></i></a>','<a class="code-editor-settings" data-tooltipster="bottom" title="'+r("Settings")+'"><i class="mbr-icon-cog"></i></a>',"</div>",'<div class="code-editor-buttons">','<button class="code-editor-cancel btn btn-fab btn-raised btn-material-red" data-tooltipster="top" title="'+r("Cancel and Close")+'"><i class="mbr-icon-times"></i></button>','<button class="code-editor-undo btn btn-fab btn-raised btn-primary" data-tooltipster="top" title="'+r("Undo")+'"><i class="mbr-icon-undo"></i></button>','<button class="code-editor-redo btn btn-fab btn-raised btn-primary" data-tooltipster="top" title="'+r("Redo")+'"><i class="mbr-icon-redo"></i></button>','<div class="code-editor-save-wrapper" data-tooltipster="top" title="'+r("Fix invalid code (marked in red)")+'">','<button class="code-editor-save btn btn-fab btn-raised btn-primary" data-tooltipster="top" title="'+r("Save and Close")+'"><i class="mbr-icon-check"></i></button>',"</div>","</div>","</div>","</section>"].join("\n")).appendTo("body");var E,y,w={lineNumbers:!0,lineWrapping:!0,foldGutter:!0,autoCloseBrackets:!0,matchBrackets:!0,showCursorWhenSelecting:!0,tabSize:4,indentUnit:4,mode:"application/x-httpd-php",theme:"mobirise",keyMap:"mbrSublime",gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],placeholder:r("Type a valid HTML code here"),matchTags:{bothTags:!0}},T=(y=[],o.on("addonLoadFinish",(function(e,o){"code-editor"==e.name&&(y=o.dynamicDependencies||[])})),function(){if(E)return E.promise();E=e.Deferred();var t=[],r=o.getAddonDir("code-editor"),i=function(){var e=t.shift();e?o.addAppScript(e).then(i):E.resolve()};return y.forEach((function(e){var i=r+"/"+("object"==typeof e?e.src:e),d="object"==typeof e&&e.type?e.type:i.split(".").pop();"js"==d?t.push(i):"css"==d&&o.addAppStyle(i)})),i(),E.promise()}),k=function(){var t="component-code-editor-preloader",r=e(o.preloaderHTML).hide()[0].outerHTML;function i(){return!!e("."+t).length}return{show:function(){i()||(e("body").prepend(e('<section class="'+t+'"><div class="'+t+'-sidebar">'+r+"</div></section>")),setTimeout((function(){e("body").addClass(t+"-open"),e("."+t).find(".preloader").show()}),250))},hide:function(){i()&&setTimeout((function(){e("."+t).remove(),e("body").removeClass(t+"-open")}),400)},isShown:i}}();o.regExtension({name:"code-editor",global:{$codeEditor:e("#component-code-editor"),$siteCodeEditor:e("#site-code-editor"),$codeEditorHTML:e("#component-code-editor .html-editor"),$codeEditorCSS:e("#component-code-editor .css-editor"),$codeEditorStaticCSS:e("#site-code-editor .css-static-editor"),$codeEditorDynamicCSS:e("#site-code-editor .css-dynamic-editor"),$codeEditorParamsJSON:e("#site-code-editor .json-params-editor"),initCodeEditor:function(){var t=this,d=CodeMirror(t.$codeEditorHTML[0],w);emmetCodeMirror(d),t.$codeEditorHTML.codemirror=d;var n,c,l,p,h,m=CodeMirror(t.$codeEditorCSS[0],e.extend({},w,{mode:"css",placeholder:r("Type a valid CSS code here")}));emmetCodeMirror(m),t.$codeEditorCSS.codemirror=m,d.on("change",(function(){a++})),m.on("change",(function(){a++})),d.on("focus",(function(){i=o.$codeEditorHTML})),m.on("focus",(function(){i=o.$codeEditorCSS})),c=t.$codeEditorCSS.parent(),l=!0,p=0,h=0,t.$codeEditor.find(".table-row-resizer").on("mousedown",(function(e){n=!0,p=e.pageY,h=c.height(),t.$iframeOverlay.show()})),t.$codeEditor.on("mousemove",(function(e){if(n){e.preventDefault();var o=Math.max(100,h+p-e.pageY);c.height(o),l&&(t.$codeEditorHTML.parent().css("height","100%"),l=!1)}})),t.$window.on("mouseup",(function(){n&&(t.$iframeOverlay.hide(),d.refresh(),m.refresh()),n=!1})),function(){var e,o,r,i=t.$codeEditorCSS.parent(),n=i.prev();t.$codeEditor.find(".vertical-divider").on("mousedown",(function(d){e=!0,o=d.pageX,r=i.width(),t.$iframeOverlay.show()})),t.$window.on("mousemove",(function(d){if(e){d.preventDefault();var s=Math.max(300,Math.min(t.$window.width()-300,r+o-d.pageX));i.css("flex-basis",s+"px"),n.css("width",s+"px")}})),t.$window.on("mouseup",(function(){e&&(e=!1,t.$iframeOverlay.hide(),d.refresh(),m.refresh())})),t.$window.on("resize",(function(e){n.css("width",""),i.css("flex-basis","")}))}(),function(){var o,r=t.$codeEditor,i=0,n=0;t.$codeEditor.find(".editor-resizer").on("mousedown",(function(d){e("body").is(".fullwidth-code-editor")||(o=!0,i=d.pageX,n=r.width(),t.$iframeOverlay.show())})),t.$window.on("mousemove",(function(e){if(o){e.preventDefault();var t=Math.max(300,Math.min(1e3,n+i-e.pageX));r.css({width:t,"max-width":"100%"})}})),t.$window.on("mouseup",(function(){o&&(t.$iframeOverlay.hide(),d.refresh(),m.refresh()),o=!1}))}(),o.$codeEditor.find("#block-anchor").on("input",(function(){C()})),s=!0},initSiteCodeEditor:function(){var t=this,d=CodeMirror(t.$codeEditorStaticCSS[0],e.extend({},w,{mode:"css",placeholder:r("Type a valid CSS code here")}));emmetCodeMirror(d),t.$codeEditorStaticCSS.codemirror=d;var n=CodeMirror(t.$codeEditorDynamicCSS[0],e.extend({},w,{mode:"css",placeholder:r("Type a valid CSS code here")}));emmetCodeMirror(n),t.$codeEditorDynamicCSS.codemirror=n;var s,a,m,u,f,b,g,v,C,S,$,E,y=CodeMirror(t.$codeEditorParamsJSON[0],e.extend({},w,{mode:"javascript",json:!0,placeholder:r("Type a valid JSON code here")}));emmetCodeMirror(y),t.$codeEditorParamsJSON.codemirror=y,d.on("change",(function(){l=!0})),n.on("change",(function(){p=!0})),y.on("change",(function(){h=!0})),d.on("focus",(function(){i=o.$codeEditorStaticCSS})),n.on("focus",(function(){i=o.$codeEditorDynamicCSS})),y.on("focus",(function(){i=o.$codeEditorParamsJSON})),v=0,C=o.$codeEditorStaticCSS.parent(),S=o.$codeEditorDynamicCSS.parent(),$=o.$codeEditorParamsJSON.parent(),E=C.prev(),o.$siteCodeEditor.find(".table-row-resizer").on("mousedown",(function(t){u=C.height(),f=$.height(),b=E.height();var r=e(t.target).hasClass("table-row-resizer")?e(t.target):e(t.target).closest(".table-row-resizer");g=r.height(),r.hasClass("resizer-1")?(a=!0,$.css("height",f)):m=!0,s=!0,v=t.pageY,o.$iframeOverlay.show()})),o.$siteCodeEditor.on("mousemove",(function(e){var t;s&&(e.preventDefault(),a?(t=Math.max(0,Math.min(o.$window.height()-f-3*b-2*g,e.pageY-65)),C.height(t)):m&&(t=Math.max(0,Math.min(o.$window.height()-u-3*b-2*g,f+v-e.pageY)),$.height(t)),S.css("height","100%"))})),o.$window.on("mouseup",(function(){s&&(o.$iframeOverlay.hide(),d.refresh(),n.refresh(),y.refresh()),s=a=m=!1})),o.$window.on("resize",(function(){C.css("height",""),S.css("height",""),$.css("height","")})),function(){var t,r,i,s,c,a,l=150,p=o.$codeEditorStaticCSS.parent(),h=o.$codeEditorDynamicCSS.parent(),m=o.$codeEditorParamsJSON.parent(),u=h.prev(),f=m.prev();o.$siteCodeEditor.find(".vertical-divider").on("mousedown",(function(d){e(d.target).hasClass("vd-1")?c=!0:a=!0,i=p.width(),s=m.width(),t=!0,r=d.pageX,o.$iframeOverlay.show()})),o.$window.on("mousemove",(function(e){var d;t&&(e.preventDefault(),c?(d=Math.max(l,Math.min(o.$window.width()-s-l,e.pageX)),p.css("flex-basis",d+"px"),u.css("width",o.$window.width()-d+"px")):a&&(d=Math.max(l,Math.min(o.$window.width()-i-l,s+r-e.pageX)),m.css("flex-basis",d+"px"),f.css("width",d+"px")))})),o.$window.on("mouseup",(function(){t&&(t=c=a=!1,o.$iframeOverlay.hide(),d.refresh(),n.refresh(),y.refresh())})),o.$window.on("resize",(function(){u.css("width",""),f.css("width",""),p.css("flex-basis",""),m.css("flex-basis","")}))}(),c=!0},showCodeEditor:function(e){if(!this.$body.hasClass("app-component-code-editor-open")){var t=this,i=e.attr("data-app-component-id"),d=t.Core.getComponent(i);t.fire("beforeShowCodeEditor",i);var n=T();if("pending"===n.state()||!s)return k.show(),void n.then((function(){t.initCodeEditor(),t.showCodeEditor(e),k.hide()}));if(d){t.fire("showCodeEditor",i),t.Core.focusComponentBlock(i),o.$codeEditor.find("#block-anchor").val(d._anchor);var c="";this.Core.getComponentHTMLforEditor(i,d).then(function(e){void 0===d._customHTML?(c=e||"",t.$codeEditorHTML.children(".html-editor-locked").length||t.$codeEditorHTML.prepend('<div class="html-editor-locked"><span><i class="icon-lock"></i>'+r("Click to Unlock HTML Editor")+"</span></div>"),t.$codeEditorHTML.parent().addClass("small")):(c=d._customHTML||"",f(d)||(c=t.Core.cleanHTMLplease(c)),t.$codeEditorHTML.children(".html-editor-locked").remove(),t.$codeEditorHTML.parent().removeClass("small")),t.$codeEditorHTML.defaultValue=c,t.$codeEditorCSS.defaultValue=d._customCSS,c=this.Core.decodeCodeEditorJS(c,d),c=this.Core.decodeCodeEditorPHP(c,d),t.$codeEditorHTML.codemirror.setValue(c),t.$codeEditorHTML.codemirror.clearHistory(),t.$codeEditorHTML.currentComponentID=i,t.$codeEditorCSS.codemirror.setValue(d._customCSS||""),t.$codeEditorCSS.codemirror.clearHistory(),t.$codeEditorCSS.currentComponentID=i,t.$body.removeClass("app-sidebar-open app-page-settings-open app-add-component-open app-component-params-open"),t.fire("hideComponents"),t.$body.addClass("app-component-code-editor-open"),t.fire("showedCodeEditor",i),a=0}.bind(this))}else a=0;o.$body.on("keyup.escListenerCodeEditor",(e=>{"Escape"!==e.key||this.$body.hasClass("modal-open")||(t.$codeEditor.find(".code-editor-cancel").trigger("click"),e.stopPropagation())})),C()}},showSiteCodeEditor:function(){if(!this.$body.hasClass("app-site-code-editor-open")){o.$body.addClass("fullwidth-code-editor");var e=T();if("pending"===e.state()||!c)return k.show(),void e.then((function(){o.initSiteCodeEditor(),o.showSiteCodeEditor(),k.hide()}));o.fire("showSiteCodeEditor"),g().then((function(e){o.$codeEditorStaticCSS.codemirror.setValue(e),o.$codeEditorStaticCSS.codemirror.clearHistory(),u||o.Core.renderComponentsStyles();var t=void 0===o.projectSettings.theme.dynamicStyles?u:o.projectSettings.theme.dynamicStyles;o.$codeEditorDynamicCSS.codemirror.setValue(t),o.$codeEditorDynamicCSS.codemirror.clearHistory(),o.$codeEditorParamsJSON.codemirror.setValue(JSON.stringify(o.theme.params.theme.settings,null,"\t")),o.$codeEditorParamsJSON.codemirror.clearHistory(),o.$body.removeClass("app-sidebar-open app-page-settings-open app-add-component-open app-component-params-open"),o.$body.addClass("app-site-code-editor-open"),l=p=h=!1,$(),o.fire("showedSiteCodeEditor")})),o.$body.on("keyup.escListenerSiteCodeEditor",(e=>{"Escape"!==e.key||this.$body.hasClass("modal-open")||(o.$siteCodeEditor.find(".code-editor-cancel").trigger("click"),e.stopPropagation())}))}},unlockHTMLEditor:function(){var e=this.$codeEditorHTML.currentComponentID;this.fire("unlockHTMLEditor",e),o.Core.convertComponentToCustomHTML(e).then((()=>{var t=o.Core.getComponent(e);o.$codeEditorHTML.defaultValue=t._customHTML||"";var r=o.Core.decodeCodeEditorJS(t._customHTML,t);(r=o.Core.decodeCodeEditorPHP(r,t))||(r=o.Core.decodeCodeEditorPHP(r,t)),o.$codeEditorHTML.codemirror.setValue(r||""),o.$codeEditorHTML.codemirror.clearHistory(),o.$codeEditorHTML.children(".html-editor-locked").remove(),o.$codeEditorHTML.parent().removeClass("small"),o.$codeEditorCSS.defaultValue=t._customCSS,o.$codeEditorCSS.codemirror.setValue(t._customCSS||""),o.$codeEditorCSS.codemirror.clearHistory(),o.fire("unlockedHTMLEditor",e)}))},previewCodeEditor:function(){var e=this,o=e.$codeEditorHTML.currentComponentID,t=e.Core.getComponent(o);t&&(e.$codeEditorHTML.children(".html-editor-locked").length||(t._customHTML=e.$codeEditorHTML.codemirror.getValue(),t._customHTML=this.Core.encodeCodeEditorPHP(t._customHTML,t),t._customHTML=this.Core.encodeCodeEditorJS(t._customHTML,t)),t._customCSS=e.$codeEditorCSS.codemirror.getValue(),e.Core.renderCodeEditorChanges(o),e.fire("previewCodeEditor",o))},closeCodeEditor:function(){var e=this,t=e.$codeEditorCSS.currentComponentID;e.fire("closeCodeEditor",t),e.$codeEditorHTML.defaultValue=e.$codeEditorHTML.currentComponentID=e.$codeEditorCSS.defaultValue=e.$codeEditorCSS.currentComponentID=void 0,e.$body.removeClass("app-component-code-editor-open"),o.$body.off("keyup.escListenerCodeEditor"),setTimeout((function(){e.fire("closedCodeEditor",t)}),200)},closeSiteCodeEditor:function(){o.fire("closeSiteCodeEditor"),l=p=h=!1,o.$body.removeClass("app-site-code-editor-open"),o.$body.off("keyup.escListenerSiteCodeEditor"),setTimeout((function(){o.fire("closedSiteCodeEditor")}),200)},saveCodeEditor:function(){var e=this.$codeEditorCSS.currentComponentID,t=this.Core.getComponent(e);this.fire("saveCodeEditor");for(var i=o.Core.resultJSON[o.Core.currentPage].components,d=o.$codeEditor.find("#block-anchor").val(),n=0;n<i.length;n++)if(i[n]._id!=e&&d===i[n]._anchor)return void o.alertDlg(r("This anchor is already used in another block."));if(t._anchor=o.$codeEditor.find("#block-anchor").val(),f(t)){var s=this.$codeEditorCSS.codemirror.getValue(),c=this.$codeEditorHTML.codemirror.getValue();c=this.Core.encodeCodeEditorPHP(c,t),c=this.Core.encodeCodeEditorJS(c,t),this.objectifyCSS(s).then((function(e){return o.SecondaryComponent.validate(c).then((function(){return e}),(function(e){throw o.$codeEditorHTML.codemirror.resetErrorHighlight(),e.line&&o.$codeEditorHTML.codemirror.highlightErrorLine(e.line-1),o.showError("<strong>"+r("HTML Editor.")+"</strong> "+e.message),c}))}),(function(e){throw o.$codeEditorCSS.codemirror.resetErrorHighlight(),e.line&&o.$codeEditorCSS.codemirror.highlightErrorLine(e.line-1),o.showError("<strong>"+r("CSS Editor.")+"</strong> Parse error: "+e.message),s})).then((function(i){let d=t._customHTML,n=t._styles;t._customHTML=c,t._customCSS=s,t._styles=i,o.Core.renderCodeEditorChanges(e).then((function(){o.closeCodeEditor(),o.fire("savedCodeEditor",e),o.Core.fire("savedCodeEditor",e)}),(function(e){if(t._customHTML=d,t._styles=n,o.$codeEditorCSS.codemirror.resetErrorHighlight(),e.extract[1]){let t=1,r=s.indexOf(e.extract[1]);s.split("\n").map((e=>e.length)).reduce((function(e,o){return e<r&&t++,e+o+1})),o.$codeEditorCSS.codemirror.highlightErrorLine(t-1)}o.showError("<strong>"+r("CSS Editor.")+"</strong> Parse error: "+e.message)}))}))}else{if(this.previewCodeEditor(),this.closeCodeEditor(),this.Core.renderCodeEditorChanges(e),t._customHTML){var a=this.Core.$template.find("[data-app-component-id="+e+"]");this.Core.initSummernote(a)}this.fire("savedCodeEditor")}},saveSiteCodeEditor:function(){o.fire("saveSiteCodeEditor");var t=o.$codeEditorStaticCSS.codemirror.getValue(),i=o.$codeEditorDynamicCSS.codemirror.getValue(),d=o.$codeEditorParamsJSON.codemirror.getValue();e.when(function(t,i){var d=e.Deferred();return"restored"===t?(delete o.projectSettings.theme.staticStyles,d.resolve()):t?o.objectifyCSS(i).then((function(e){o.projectSettings.theme.staticStyles=i,d.resolve()}),(function(e){o.$codeEditorStaticCSS.codemirror.resetErrorHighlight(),e.line&&o.$codeEditorStaticCSS.codemirror.highlightErrorLine(e.line-1),o.showError("<strong>"+r("Static Styles.")+"</strong> Parse error: "+e.message),d.reject()})):d.resolve(),d.promise()}(l,t),function(t,i){var d=e.Deferred();if("restored"===t)delete o.projectSettings.theme.dynamicStyles,d.resolve();else if(t){var n=o.Core.applyFilter("beforeRenderStylesForComponent",i);o.iwindow.less.render(n,(function(e,t){e?(o.$codeEditorDynamicCSS.codemirror.resetErrorHighlight(),e.line&&o.$codeEditorDynamicCSS.codemirror.highlightErrorLine(e.line-(n.split("\n").length-i.split("\n").length+1)),o.showError("<strong>"+r("Dynamic Styles.")+"</strong> Parse error: "+e.message),d.reject()):(o.projectSettings.theme.dynamicStyles=i,d.resolve())}))}else d.resolve();return d.promise()}(p,i),function(t,i){var d=e.Deferred();if("restored"===t)delete o.projectSettings.theme.settings,d.resolve();else if(t){""===i&&(i="[]");try{var n=e.parseJSON(i)}catch(e){console.error("Error parse settings:",e);var[s,c]=e.message.split("at position");if(o.$codeEditorParamsJSON.codemirror.resetErrorHighlight(),c){if(1!==c&&c!==i.length-1){let e=1;i.split("\n").map((e=>e.length)).reduce((function(o,t){return o<c&&e++,o+t+1})),c=e}else c!==i.length-1&&(c=i.split("\n").length);o.$codeEditorParamsJSON.codemirror.highlightErrorLine(c-1)}return o.showError("<strong>"+r("Site Parameters.")+"</strong> Parse error: "+(s||e)),d.reject(),d.promise()}o.projectSettings.theme.settings=o.theme.params.theme.settings=n,d.resolve()}else d.resolve();return d.promise()}(h,d)).done((function(e,t,r){o.redrawStyleChanger(),o.Core.renderComponentsStyles(),o.closeSiteCodeEditor(),o.fire("savedSiteCodeEditor")}))},cancelCodeEditor:function(){var e=this.$codeEditorHTML.currentComponentID,o=this.Core.getComponent(e);this.fire("cancelCodeEditor",e),void 0!==o._customHTML&&(o._customHTML=this.$codeEditorHTML.defaultValue),o._customCSS=this.$codeEditorCSS.defaultValue,this.Core.renderCodeEditorChanges(e),this.closeCodeEditor(),this.fire("canceledCodeEditor",e)}},events:{beforeAppLoad:function(){o.Core.addFilter("prepareComponent",(function(o,t){var i=e("<div>").html(o),d='<span class="mbr-btn component-code mbr-icon-code" data-tooltipster="bottom" title="'+r("Edit Code")+'"></span>';return i.find(".component-code-fake").length&&i.find(".component-code-fake").remove(),i.find(".component-params").length?(i.find(".component-params").before(d),!f(t)&&t._customHTML&&i.find(".component-params").remove()):i.find(".component-remove").length&&i.find(".component-remove").before(d),o=i.html(),i.remove(),o})),o.addFilter("getPluginResource",(function(e,t,r){return void 0!==o.projectSettings.theme.staticStyles&&0===t.indexOf("Theme")&&"css"===r&&o.appSettings.removeMobiriseReferences&&(e.css=""),e})),o.addFilter("insertThemeStyleAmp",(function(e){return void 0!==o.projectSettings.theme.staticStyles&&(e=!1),e})),o.addFilter("publishFiles",(function(e){if(void 0!==o.projectSettings.theme.staticStyles){var t=o.getPlugin("Theme");if(t)for(var r in t.files){var i=t.files[r];if("string"==typeof i&&(i={src:i}),/.css$/g.test(i.src))for(var d=0;d<e.length;d++)if(e[d].dest.indexOf(i.src)>=0){for(var n=e[d].srcList,s=0;s<n.length;s++)if(n[s].src.indexOf(i.src)>=0){n.splice(s,1);break}n.length||e.splice(d,1);break}}}return e})),o.Core.addFilter("afterRenderStyles",(function(e,t,r){return n||(n=function(){var e,t=o.getPlugin("Theme");if(t)for(var r in t.files){var i=t.files[r];if("string"==typeof i&&(i={src:i}),/.css$/g.test(i.src))return o.Core.$document.find('head [rel="stylesheet"]').each((function(o,t){if(t.sheet.href.indexOf(i.src)>0)return e=t.sheet,!1})),e}else console.warn("Theme CSS styles not found!")}()),void 0===o.projectSettings.theme.staticStyles?(n.disabled=!1,e):(n.disabled=!0,e)})),o.addFilter("getCustomLessText",(function(e){return u||(u=e),e}))},load:function(){var n=this;n.addFilter("preventParamsShow",(function(e,o){if(!e){var t=n.Core.getComponent(o);if(t&&t._customTemplate)return!0}return e})),n.addFilter("pageNameFullEdit",(function(){return!0})),n.addFilter("showAllBlockButtons",(function(){return"true"})),o.addFilter("addAppSettingsItem",(function(e){return[e,'<label class="col-md-3">'+r("Code Editor")+"</label>",'<div class="col-md-9 app-code-editor-settings">',"<br>",'<div class="setting">','<div class="row">',"<label>"+r("Select Color Scheme")+"</label>",'<div class="input-group">','<select class="form-control" name="theme">','<option value="mobirise">default</option>','<option value="default">light</option>','<option value="monokai">contrast</option>',"</select>","</div>","</div>","</div>",'<div class="setting">','<div class="row">','<div class="togglebutton">','<label data-tooltipster="right" data-tooltip-class="setting-image" data-tooltip-src="app/builder/images/app_settings/show-code-editor-undo.jpg">','<input name="show-code-editor-undo" type="checkbox"'+(o.appSettings.showCodeEditorUndo?'checked="checked"':"")+'><span style="margin-top:-3px;" class="toggle"></span>'+r("Show Undo/Redo"),"</label>","</div>","</div>","</div>",'<div class="setting">','<div class="row">','<div class="togglebutton">',"<label>",'<input name="remove-mobirise-references" type="checkbox"'+(o.appSettings.removeMobiriseReferences?'checked="checked"':"")+'><span style="margin-top:-3px;" class="toggle"></span>'+r('Remove "Mobirise" from HTML'),"</label>","</div>","</div>","</div>","</div>"].join("\n")})),o.addFilter("sidebarProjectSettings",(function(e){var o={title:r("Global HTML Insert"),name:"global-HTML",html:'<div class="form-group row col-md-12"><label for="site_lang" class="col-xs-4 control-label">'+r("HTML lang=")+'</label><div class="col-xs-3"><input id="site_lang" class="form-control" type="text" placeholder="en" value=""></div></div><div class="form-group col-md-12"><label for="global_header_custom" class="control-label">'+r("Before $/head$ code:").replace("$/head$","&lt;/head&gt;")+'</label><textarea id="global_header_custom" class="form-control" rows="5" placeholder="'+r("Paste the HTML code you want to have on every page, right before $/head$ tag").replace("$/head$","&lt;/head&gt;")+'"></textarea></div><div class="form-group col-md-12"><label for="global_after_body" class="control-label">'+r("After $body$ code:").replace("$body$","&lt;body&gt;")+'</label><textarea id="global_after_body" class="form-control" rows="5" placeholder="'+r("Paste the HTML code you want to have on every page, right after $body$ tag").replace("$body$","&lt;body&gt;")+'"></textarea></div><div class="form-group col-md-12"><label for="global_footer_custom" class="control-label">'+r("Before $/body$ code:").replace("$/body$","&lt;/body&gt;")+'</label><textarea id="global_footer_custom" class="form-control" rows="5" placeholder="'+r("Paste the HTML code you want to have on every page, right before $/body$ tag").replace("$/body$","&lt;/body&gt;")+'"></textarea></div><div class="form-group col-md-12"><label for="global_before_html" class="control-label">'+r("Before $!DOCTYPE$, $html$ and $head$ tags:").replace("$!DOCTYPE$","&lt;!DOCTYPE&gt;").replace("$html$","&lt;html&gt;").replace("$head$","&lt;head&gt;")+'</label><textarea id="global_before_html" class="form-control" rows="5" placeholder="'+r("Paste the code you want to have in the VERY FIRST LINE of your page, before $!DOCTYPE$, $html$ and $head$ tags. Use for server side scripts (PHP, ASP, etc)").replace("$!DOCTYPE$","&lt;!DOCTYPE&gt;").replace("$html$","&lt;html&gt;").replace("$head$","&lt;head&gt;")+'"></textarea></div>'};return e.push(o),e})),n.$body.find("#app-page-settings .app-layer-cont").append('<div class="form-group"><label for="page_header_custom">'+r("Inside $head$ code:").replace("$head$","&lt;head&gt;")+'</label><textarea id="page_header_custom" class="form-control" data-page-settings="header_custom" rows="5" placeholder="'+r("Paste any valid HTML code here. The code will be inserted to the end of $head$ section, right before $/head$").replace("$head$","&lt;head&gt;").replace("$/head$","&lt;/head&gt;")+'"></textarea></div><div class="form-group"><label for="page_footer_custom">'+r("End of $body$ code:").replace("$body$","&lt;body&gt;")+'</label><textarea id="page_footer_custom" class="form-control" data-page-settings="footer_custom" rows="5" placeholder="'+r("Paste any valid HTML code here. The code will be inserted to the end of $body$ section, right before $/body$ tag").replace("$body$","&lt;body&gt;").replace("$/body$","&lt;/body&gt;")+'"></textarea></div><div class="form-group"><label for="page_before_html">'+r("Before $!DOCTYPE$, $html$ and $head$ tags:").replace("$!DOCTYPE$","&lt;!DOCTYPE&gt;").replace("$html$","&lt;html&gt;").replace("$head$","&lt;head&gt;")+'</label><textarea id="page_before_html" class="form-control" data-page-settings="html_before" rows="5" placeholder="'+r("Paste the code you want to have in the VERY FIRST LINE of your page, before $!DOCTYPE$, $html$ and $head$ tags. Use for server side scripts (PHP, ASP, etc)").replace("$!DOCTYPE$","&lt;!DOCTYPE&gt;").replace("$html$","&lt;html&gt;").replace("$head$","&lt;head&gt;")+'"></textarea></div>'),n.$template.on("click",".component-code",(function(){n.showCodeEditor(e(this).parents("[data-app-component-id]:eq(0)"))})),n.on("componentClicked",(function(o,t){var r=n.Core.getComponent(o);e(t.target).is(".mbr-editable-image")||f(r)||r._customHTML&&(e(t.target).is("[code-editable-id]:not(img)")?this.Core.initSummernote(e(t.target)):n.showCodeEditor(n.$template.find("[data-app-component-id="+o+"]")))})),n.$codeEditor.on("click",".html-editor-locked",(function(){n.confirmDlg({message:"<p>"+r("Do you want to unlock the HTML editor?")+"</p>"+r("If you unlock the HTML editor, you will not be able to work with %Block Parameters% anymore. It doesn't affect to other blocks.").replace(/%(.+)%/,'<br><span class="btn btn-component-params mbr-icon-cog"></span> <strong>$1</strong>'),callback:function(e){e&&n.unlockHTMLEditor()},buttons:{cancel:{label:r("No")},confirm:{label:r("Yes")}}})})),n.$codeEditor.on("click",".code-editor-preview",(function(){n.$codeEditor.toggleClass("code-editor-hide"),n.$codeEditor.hasClass("code-editor-hide")?(n.previewCodeEditor(),e(this).children("i").attr("class","mbr-icon-code")):e(this).children("i").attr("class","mbr-icon-eye")})),n.$codeEditor.on("mouseleave",".code-editor-preview",(function(){n.$codeEditor.removeClass("code-editor-hide"),e(this).children("i").attr("class","mbr-icon-eye")})),o.$codeEditor.on("keyup paste cut",(function(){C()})),o.$siteCodeEditor.on("keyup paste cut",(function(){$()})),o.$codeEditor.on("click",".code-editor-save",(function(){o.saveCodeEditor()})),o.$siteCodeEditor.on("click",".code-editor-save",(function(){o.saveSiteCodeEditor()})),o.$codeEditor.on("mousedown",".code-editor-undo",(function(e){i&&i.codemirror.undo(),C()})),o.$codeEditor.on("click",".code-editor-redo",(function(e){i&&i.codemirror.redo(),C()})),o.$siteCodeEditor.on("mousedown",".code-editor-undo",(function(e){"restored"===l&&"restored"===p&&"restored"===h?(o.$codeEditorStaticCSS.codemirror.undo(),o.$codeEditorDynamicCSS.codemirror.undo(),o.$codeEditorParamsJSON.codemirror.undo(),l=p=h=!0):i&&i.codemirror.undo(),$()})),o.$siteCodeEditor.on("click",".code-editor-redo",(function(e){i&&(i.codemirror.redo(),$())})),n.$codeEditor.on("click",".code-editor-cancel",(function(){a?n.confirmDlg({message:r("Do you want to close the code editor? Changes will not be saved."),callback:function(e){e&&n.cancelCodeEditor()},buttons:{cancel:{label:r("No")},confirm:{label:r("Yes")}}}):n.cancelCodeEditor()})),o.$siteCodeEditor.on("click",".code-editor-cancel",(function(){l||p||h?o.confirmDlg({message:r("Do you want to close the code editor? Changes will not be saved."),callback:function(e){e&&o.closeSiteCodeEditor()},buttons:{cancel:{label:r("No")},confirm:{label:r("Yes")}}}):o.closeSiteCodeEditor()}));var s="";o.$body.on("click",".code-editor-top-buttons .code-editor-help",(function(){if(!s){var t=[{shortcut:"Ctrl+X",description:r("Cut line")},{shortcut:"Ctrl+Enter",description:r("Insert line after")},{shortcut:"Ctrl+Shift+Enter",description:r("Insert line before")},{shortcut:"Ctrl+Shift+Up",description:r("Move line/selection up")},{shortcut:"Ctrl+Shift+Down",description:r("Move line/selection down")},{shortcut:"Ctrl+L",description:r("Select line")},{shortcut:"Ctrl+D",description:r("Select word - repeat select others occurrences")},{shortcut:"Ctrl+M",description:r("Jump to matching brackets")},{shortcut:"Ctrl+Shift+M",description:r("Select between brackets")},{shortcut:"Ctrl+Shift+K",description:r("Delete line")},{shortcut:"Ctrl+Shift+L",description:r("Split selection by line")},{shortcut:"Ctrl + ]",description:r("Indent current line(s)")},{shortcut:"Ctrl + [",description:r("Un-indent current line(s)")},{shortcut:"Ctrl+Shift+D",description:r("Duplicate line(s)")},{shortcut:"Ctrl+J",description:r("Join line below to the end of the current line")},{shortcut:"Ctrl+/",description:r("Comment/un-comment current line")},{shortcut:"Ctrl+F2",description:r("Toggle bookmark")},{shortcut:"F2",description:r("Next bookmark")},{shortcut:"Shift+F2",description:r("Previous bookmark")},{shortcut:"Ctrl+Shift+F2",description:r("Clear bookmarks")},{shortcut:"Ctrl+K,U",description:r("Transform to uppercase")},{shortcut:"Ctrl+K ,L",description:r("Transform to lowercase")},{shortcut:"Alt+Shift+Up",description:r("Add cursor to previous line")},{shortcut:"Alt+Shift+Down",description:r("Add cursor to next line")},{shortcut:"Ctrl+F",description:r("Find")},{shortcut:"Ctrl+H",description:r("Replace")},{shortcut:"F3",description:r("Find next occurrence of searched word")},{shortcut:"Ctrl+F3",description:r("Find previous occurrence of searched word")},{shortcut:"Alt+F3",description:r("Select all occurrences of current word")},{shortcut:"Ctrl+Shift+[",description:r("Fold")},{shortcut:"Ctrl+Shift+]",description:r("Unfold")},{shortcut:"Ctrl+K,0",description:r("Unfold all")},{shortcut:"F9",description:r("Sort lines")},{shortcut:"Ctrl+F9",description:r("Sort lines insensitive")}],i=e('<div class="kb-row"><div class="kb-column kb-shortcut"></div><div class="kb-column kb-description"></div></div>'),d=i.clone();d.addClass("kb-header"),d.find(".kb-shortcut").html("Shortcut"),d.find(".kb-description").html("Description"),s+=d[0].outerHTML;for(var n=0;n<t.length;n++){for(var c=i.clone(),a=t[n].shortcut.split("+"),l="",p=0;p<a.length;p++){if(a[p].indexOf(",")>0){for(var h=a[p].split(","),m="",u=0;u<h.length;u++)m+="<kbd>"+h[u]+"</kbd>";l+=m}else l+="<kbd>"+a[p]+"</kbd>";p!==a.length-1&&(l+="+")}c.find(".kb-shortcut").html(l),c.find(".kb-description").html(t[n].description),s+=c[0].outerHTML}}o.showDialog({title:r("Code Editor Quick Help"),className:"code-editor-help-dialog",body:'<div class="row form-group"><div class="col-md-12"><div class="help-links"><a class="link-ce-tutorial" href="https://mobirise.com/extensions/code-editor.html"><i class="mbr-icon-youtube"></i>'+r("View video tutorial")+'</a><a class="link-ce-help" href="https://mobirise.com/help/code-editor-474.html"><i class="mbr-icon-question-circle"></i>'+r("Visit help page")+'</a></div><p><b>Keyboard shortcuts:</b></p><div class="kb-shortcuts">'+s+"</div></div></div>",show:function(e){e.find(".link-ce-tutorial").click((function(e){e.preventDefault(),o.openUrl("https://mobirise.com/extensions/code-editor.html")})),e.find(".link-ce-help").click((function(e){e.preventDefault(),o.openUrl("https://mobirise.com/help/code-editor-474.html")}))}})})),o.$body.on("click",".code-editor-top-buttons .code-editor-settings",(function(){o.showAppSettings(),o.$body.find(".app-settings-dialog .app-code-editor-settings").addClass("selected")})),o.$siteCodeEditor.on("click",".code-editor-top-buttons .code-editor-restore",(function(){o.confirmDlg(r("Restore all settings to default values?"),(function(e){e&&g(!0).then((function(e){o.$codeEditorStaticCSS.codemirror.setValue(e),o.$codeEditorDynamicCSS.codemirror.setValue(u),o.$codeEditorParamsJSON.codemirror.setValue(JSON.stringify(d,null,"\t")),l=p=h="restored",$()}))}))})),n.$template.on("click","[code-editable-id].mbr-editable-image",(function(o){o.preventDefault();var r=this;t.runFileDialog("Select Image","","Images (*.jpg *.jpeg *.png *.gif *.bmp *.tiff)",(function(o){o&&t.moveFileClean(o,n.projectPath?n.projectPath+"/assets/images":"",(function(o){e(r).attr("src",o),n.Core.changeEditableElement(r)}))}))}))},unlockHTMLEditor:function(e){var t=o.Core.$template.find("[data-app-component-id="+e+"]");o.Core.destroySummernote(t)},initThemeSettings:function(){d||(d=o.theme.params.theme.settings),void 0===o.projectSettings.theme.settings&&(o.theme.params.theme.settings=d)},initSettingsSidebar:function(){b()},redrawStyleChanger:function(){b()},shownSidebarProjectSettings:function(t,r){var i=o.projectSettings.site_lang||"",d=o.projectSettings.global_header_custom||"",n=o.projectSettings.global_after_body||"",s=o.projectSettings.global_footer_custom||"",c=o.projectSettings.global_before_html||"";e("#site_lang").val(i),e("#global_header_custom").val(d),e("#global_after_body").val(n),e("#global_footer_custom").val(s),e("#global_before_html").val(c),e("#site_lang").change((function(e){o.projectSettings.site_lang=e.target.value})),e("#global_header_custom").change((function(e){o.projectSettings.global_header_custom=e.target.value})),e("#global_after_body").change((function(e){o.projectSettings.global_after_body=e.target.value})),e("#global_footer_custom").change((function(e){o.projectSettings.global_footer_custom=e.target.value})),e("#global_before_html").change((function(e){o.projectSettings.global_before_html=e.target.value}))}}})}),["jQuery","mbrApp","Bridge","TR()"]);